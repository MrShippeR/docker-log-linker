#!/usr/bin/env bash
set -euo pipefail

# ======================================================
# Docker Log Linker
# Creates symlinks to container logs for monitoring tools
# ======================================================

CONFIG_FILE="/etc/docker-log-linker/docker-log-linker.conf"
MAIN_LOGFILE="/var/log/docker-log-linker/docker-log-linker.log"
TEST_MODE=false

# ======================================================
# Argument handling
# ======================================================
if [[ "${1-}" == "test" ]]; then
    TEST_MODE=true
    echo "[docker-log-linker] Running in TEST mode"
fi

# ======================================================
# Global container arrays (index-linked)
# ======================================================
declare -a container_name
declare -a container_id
declare -a container_source_des
declare -a container_target_des

declare -a _containers_raw

# ======================================================
# Helper functions
# ======================================================
log() {
    local msg="$1"
    local ts
    ts="$(TZ=:/etc/localtime date '+%Y-%m-%d %H:%M:%S')"

    if [[ "$TEST_MODE" == true ]]; then
        echo "[$ts] $msg"
    else
        echo "[$ts] $msg" | tee -a "${MAIN_LOGFILE:-/dev/null}"
    fi
}

die() {
    log "ERROR: $1"
    log "Exiting program because of defined error in code happened."
    exit 1
}

my_create_directory() {
    local dir="${1%/}"

    if $TEST_MODE; then
        echo "[TEST] Would create directory: $dir (owner: $DIR_OWNER_USER:$DIR_OWNER_GROUP)"
        return 0
    fi

    if [[ ! -d "$dir" ]]; then
        mkdir -p "$dir" || die "Cannot create directory: $dir"
        chown "$DIR_OWNER_USER:$DIR_OWNER_GROUP" "$dir" || \
            log "WARNING: Cannot set owner for $dir"
        log "Created directory: $dir"
    fi
}

# ======================================================
# Docker avaibility
# ======================================================

wait_for_docker() {    
    local tries=0
    local max_tries="$DELAY_AFTER_DOCKER_START"

    while ! docker version >/dev/null 2>&1; do
        ((tries++))
        if (( tries > max_tries )); then
            die "Docker daemon not available after $max_tries tries."
        fi
        log "Docker daemon not ready yet, waiting 1s..."
        sleep 1
    done

    log "Docker daemon is available."
}

# ======================================================
# Configuration loading
# ======================================================
load_configuration_global() {
    log "Loading section GLOBAL in config file $CONFIG_FILE"

    [[ ! -f "$CONFIG_FILE" ]] && die "Configuration file not found"

    eval "$(
        sed '/^\[CONTAINERS\]/,$d' "$CONFIG_FILE"
    )"
    
    if [[ -z "${MODE+x}" ]]; then
        die "MODE is not defined in configuration. Variable MODE must be set to value ONE_PLACE or SEPARATELY_DEFINED."
    fi

    if [[ "$MODE" != "ONE_PLACE" && "$MODE" != "SEPARATELY_DEFINED" ]]; then
        die "Invalid MODE: $MODE"
    fi
    
    if [[ -z "${CREATE_ALL_CONTAINERS_LOGS+x}" ]]; then
        die "CREATE_ALL_CONTAINERS_LOGS is not defined in configuration. Variable CREATE_ALL_CONTAINERS_LOGS must be set to value true or false."
    fi

    if [[ "$CREATE_ALL_CONTAINERS_LOGS" != "true" && \
          "$CREATE_ALL_CONTAINERS_LOGS" != "false" ]]; then
        die "CREATE_ALL_CONTAINERS_LOGS must be true or false, now is $CREATE_ALL_CONTAINERS_LOGS"
    fi
    
    if [[ "$CREATE_ALL_CONTAINERS_LOGS" == "true" && "$MODE" != "ONE_PLACE" ]]; then
        log "INFO: Changing value MODE to ONE_PLACE because CREATE_ALL_CONTAINERS_LOGS is true."
        MODE="ONE_PLACE"
    fi
}

load_configuration_containers_section() {
    log "Loading section CONTAINERS in config file."
    mapfile -t _containers_raw < <(
        sed -n '/^\[CONTAINERS\]/,/^\[/{//!p}' "$CONFIG_FILE" \
        | sed 's/#.*//' \
        | sed 's/[[:space:]]//g' \
        | grep -v '^$'
    )
}

# ======================================================
# Parsing container configuration
# ======================================================
parse_configuration_containers_one_place() {
    for entry in "${_containers_raw[@]}"; do
        if [[ "$entry" == *:* ]]; then
            die "Invalid entry for ONE_PLACE mode (contains colon): $entry"
        fi
        container_name+=("$entry")
        container_id+=("")
        container_source_des+=("")
        container_target_des+=("${CENTRAL_DIRECTORY%/}")
    done

    if [[ "${#container_name[@]}" -eq 0 ]]; then
        die "No containers defined in config section [CONTAINERS] for ONE_PLACE mode"
    fi
}


parse_configuration_containers_separately_defined() {
    for entry in "${_containers_raw[@]}"; do
        if [[ "$entry" != *:* ]]; then
            die "Invalid entry for SEPARATELY_DEFINED mode (missing colon): $entry"
        fi

        if [[ "$entry" =~ ^([^:]+):(.+)$ ]]; then
            container_name+=("${BASH_REMATCH[1]}")
            container_id+=("")
            container_source_des+=("")
            container_target_des+=("${BASH_REMATCH[2]%/}")
        else
            log "WARNING: Invalid CONTAINERS entry format: $entry"
        fi
    done

    if [[ "${#container_name[@]}" -eq 0 ]]; then
        die "No valid containers defined in config section [CONTAINERS] for SEPARATELY_DEFINED mode"
    fi
}



# ======================================================
# Container discovery (ALL containers)
# ======================================================
prepare_list_of_all_containers() {
    mapfile -t running_containers < <(docker ps --format '{{.ID}} {{.Names}}')
    if [[ "${#running_containers[@]}" -eq 0 ]]; then
        die "No running Docker containers found."
    fi

    for line in "${running_containers[@]}"; do
        cname="${line#* }"
        cid="${line%% *}"

        container_name+=("$cname")
        container_id+=("$cid")
        container_source_des+=("")
        container_target_des+=("${CENTRAL_DIRECTORY%/}")
    done

    log "Found ${#container_name[@]} running Docker container(s)."
}


# ======================================================
# Container inspection
# ======================================================
prepare_containers_list() {
    for i in "${!container_name[@]}"; do
        local name="${container_name[$i]}"

        if [[ -z "${container_id[$i]}" ]]; then
            if docker inspect "$name" >/dev/null 2>&1; then
                container_id[$i]="$name"
            else
                cid="$(docker ps --format '{{.ID}} {{.Names}}' | awk -v n="$name" '$2==n {print $1}')"
                [[ -z "$cid" ]] && die "Container $name not found"
                container_id[$i]="$cid"
            fi
        fi

        log_path="$(docker inspect --format='{{.LogPath}}' "${container_id[$i]}")"
        [[ ! -f "$log_path" ]] && \
            die "Log file not found for container $name"

        container_source_des[$i]="$log_path"
    done
}

# ======================================================
# Destination preparation
# ======================================================
create_log_destinations() {
    for dir in "${container_target_des[@]}"; do
        my_create_directory "$dir"
    done
}

# ======================================================
# Symlink creation
# ======================================================
create_symlinks() {
    log "Generating symlinks..."

    for i in "${!container_name[@]}"; do
        link="${container_target_des[$i]}/${container_name[$i]}.log"
        src="${container_source_des[$i]}"

        if $TEST_MODE; then
            echo "[TEST] Would link: $link -> $src"
            continue
        fi

        ln -sf "$src" "$link" || log "ERROR: Cannot create symlink $link"
        log "Linked: $link"
    done
}

# ======================================================
# Main execution flow
# ======================================================
log "Starting Docker Log Linker."

load_configuration_global
wait_for_docker

if [[ "$CREATE_ALL_CONTAINERS_LOGS" == "true" ]]; then
    prepare_list_of_all_containers
else
    load_configuration_containers_section
    case "$MODE" in
        ONE_PLACE)
            parse_configuration_containers_one_place
            ;;
        SEPARATELY_DEFINED)
            parse_configuration_containers_separately_defined
            ;;
    esac
fi

prepare_containers_list
create_log_destinations
create_symlinks

log "All operations successfully completed, ending program."

